<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³å®˜æ–¹å¸³è™Ÿæœå‹™</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; }
        /* è¼‰å…¥ç•«é¢ */
        #loading-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: url('https://i.ibb.co/93NGBjjh/IMG-6773.jpg') no-repeat center center;
            background-size: cover; z-index: 9999;
        }
        .container { padding: 20px; }
        .nav-bar { display: flex; overflow-x: auto; background: #eee; padding: 10px; position: sticky; top:0; }
        .nav-item { padding: 10px; white-space: nowrap; cursor: pointer; }
        .active { color: #00b900; font-weight: bold; border-bottom: 2px solid #00b900; }
        .card { border: 1px solid #ddd; margin-bottom: 10px; padding: 15px; border-radius: 8px; }
        .admin-tag { background: red; color: white; padding: 2px 5px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="app">
        <div id="loading-screen" v-if="isLoading"></div>

        <div v-else class="container">
            <div class="nav-bar">
                <div class="nav-item" :class="{active: tab==='menu'}" @click="tab='menu'">é¤å»³èœå–®</div>
                <div class="nav-item" :class="{active: tab==='booking'}" @click="tab='booking'">ç·šä¸Šè¨‚ä½</div>
                <div class="nav-item" :class="{active: tab==='faq'}" @click="tab='faq'">å¸¸è¦‹å•é¡Œ</div>
                <div class="nav-item" :class="{active: tab==='member'}" @click="tab='member'">æœƒå“¡ä¸­å¿ƒ</div>
                <div v-if="isAdmin" class="nav-item" :class="{active: tab==='admin'}" @click="tab='admin'">å¾Œå°ç®¡ç† ğŸ”’</div>
            </div>

            <div v-if="tab==='menu'">
                <h2>ç²¾é¸èœå–®</h2>
                <div v-for="item in menuData" class="card">
                    <img :src="item.åœ–ç‰‡é€£çµ" style="width:100%; border-radius: 5px;">
                    <h3>{{item.å“é …}} - ${{item.åƒ¹æ ¼}}</h3>
                </div>
            </div>

            <div v-if="tab==='booking'">
                <h2>ç·šä¸Šè¨‚ä½</h2>
                <form @submit.prevent="submitBooking">
                    <p>æ—¥æœŸï¼š<input type="date" v-model="form.date" required @change="checkMonday"></p>
                    <p>æ™‚é–“ï¼š<input type="time" v-model="form.time" required></p>
                    <p>äººæ•¸ï¼š<input type="number" v-model="form.guests" min="1" required></p>
                    <p>é é»èœå–®ï¼š<textarea v-model="form.preOrder" placeholder="è«‹è¼¸å…¥é¤é»åç¨±èˆ‡æ•¸é‡"></textarea></p>
                    <button type="submit" style="width:100%; padding:10px; background:#00b900; color:#fff;">ç¢ºèªè¨‚ä½</button>
                </form>
            </div>

            <div v-if="tab==='member'">
                <h2>æœƒå“¡ä¸­å¿ƒ</h2>
                <div v-if="!userProfile.userId">LIFF ç™»å…¥ä¸­...</div>
                <div v-else>
                    <p>å§“åï¼š{{userProfile.displayName}}</p>
                    <p>æ‰‹æ©Ÿï¼š<input type="tel" v-model="phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰æ¬Šé™"></p>
                    <button @click="verifyRole">é©—è­‰èº«åˆ†</button>
                    <p v-if="isAdmin"><span class="admin-tag">ç®¡ç†å“¡æ¨¡å¼å·²å•Ÿå‹•</span></p>
                </div>
            </div>

            <div v-if="tab==='admin' && isAdmin">
                <h2>ğŸ“Š å¾Œå°ç®¡ç†ç³»çµ±</h2>
                <div class="card">
                    <h3>ä»Šæ—¥ç‡Ÿæ”¶çµ±è¨ˆ (POS)</h3>
                    <p>ç¸½è¨‚å–®ï¼š{{adminData.posStats.length}} ç­†</p>
                </div>
                <h3>å³å°‡åˆ°ä¾†è¨‚ä½</h3>
                <div v-for="res in adminData.allReservations" class="card">
                    <p>å®¢æˆ¶ï¼š{{res.å§“å}} ({{res.äººæ•¸}}äºº)</p>
                    <p>æ™‚é–“ï¼š{{res.æ—¥æœŸ}} {{res.æ™‚é–“}}</p>
                    <p>é é»ï¼š{{res.é é»å…§å®¹}}</p>
                    <button>ä¿®æ”¹ç‹€æ…‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = 'æ‚¨çš„_GAS_ç¶²é æ‡‰ç”¨ç¨‹å¼_URL';

        Vue.createApp({
            data() {
                return {
                    isLoading: true,
                    tab: 'menu',
                    phone: '',
                    isAdmin: false,
                    userProfile: {},
                    menuData: [],
                    adminData: { allReservations: [], posStats: [] },
                    form: { date: '', time: '', guests: 1, preOrder: '' }
                }
            },
            mounted() {
                // åˆå§‹åŒ– LIFF
                liff.init({ liffId: "2008861231-1aeXBtp0" }).then(() => {
                    if (liff.isLoggedIn()) {
                        liff.getProfile().then(profile => {
                            this.userProfile = profile;
                            this.fetchData();
                        });
                    } else {
                        liff.login();
                    }
                });
                // 3ç§’å¾Œé—œé–‰å•Ÿå‹•åœ–
                setTimeout(() => { this.isLoading = false; }, 3000);
            },
            methods: {
                fetchData() {
                    fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'getInitialData' })
                    }).then(res => res.json()).then(data => {
                        this.menuData = data.menu;
                    });
                },
                checkMonday() {
                    let day = new Date(this.form.date).getDay();
                    if (day === 1) {
                        alert("é€±ä¸€ç‚ºæœ¬é¤å»³å…¬ä¼‘æ—¥ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸï¼");
                        this.form.date = "";
                    }
                },
                submitBooking() {
                    fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            action: 'submitReservation', 
                            data: { ...this.form, name: this.userProfile.displayName, phone: this.phone }
                        })
                    }).then(res => res.json()).then(data => {
                        alert(data.msg);
                        if(data.success) {
                            liff.sendMessages([{ type: 'text', text: `ğŸ”” è¨‚ä½é€šçŸ¥ï¼šå·²æˆåŠŸé ç´„ ${this.form.date} ${this.form.time}` }]);
                        }
                    });
                },
                verifyRole() {
                    fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'getAdminData', phone: this.phone })
                    }).then(res => res.json()).then(data => {
                        if (data.isManager) {
                            this.isAdmin = true;
                            this.adminData.allReservations = data.allReservations;
                            this.adminData.posStats = data.posStats;
                            alert("å·²é€²å…¥ç®¡ç†å“¡æ¨¡å¼");
                        } else {
                            alert("æ‰‹æ©Ÿè™Ÿç¢¼ç„¡ç®¡ç†æ¬Šé™");
                        }
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>